<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <style>
        .headingDiv {
            border: 5px outset grey;
            /* background-color: lightblue; */
            text-align: center;
        }
        
        .classImbTitle, .scaleImbTitle,  .objLocImbTitle{
            text-align: center;
        }

    </style>
</head>

<body>
    <div class="headingDiv">
        <h1>Dataset Imbalance Graphical Suport Tool</h1>
        <p> Chosen dataset for analisys: <input type="file" onchange="loadFile()" /></p>
    </div>
    <div id="classImbDiv">
        <h2 class="classImbTitle">Class Imbalance</h1>
        <div id="horizBarDiv"></div>
        <div id="pieDiv"></div>
        <div id="lineDiv"></div>
    </div>
    <div id="scaleImbDiv">
        <h2 class="scaleImbTitle">Scale Imbalance</h1>
    </div>
    <div id="objLocImbDiv">
        <h2 class="objLocImbTitle">Object Location Imbalance</h1>

    </div>
    <!-- TODO: tirar <<DEBUG>> -->
    <div id="debugDiv">
        <div id="debugDiv1"></div>
        <div id="debugDiv2"></div>
        <div id="debugDiv3"></div>
        <div id="debugDiv4"></div>
        <div id="debugDiv5"></div>
        <div id="debugDiv6"></div>
    </div>

    <script>
        //Loading all from google chart API that will be used
        google.charts.load('current', {'packages':['bar']});
        google.charts.load('current', {'packages':['corechart']});
        google.charts.load('current', {'packages':['table']}); //TODO: tirar <<DEBUG>>

        //Some globals that every chart can access
        var current_selected_classes = [];

        //open the file uploaded by user
        var reader = new FileReader();  
    
        function loadFile() {      
            var file = document.querySelector('input[type=file]').files[0];
            //TODO: tirar <<DEBUG>>
            console.log(file.name);

            reader.addEventListener("load", parseFile, false);
            if (file) {
                reader.readAsText(file);
            }
        }
    
        //Parse the uploaded JSON
        function parseFile(){
            var data_json = JSON.parse(reader.result);
            console.log(data_json);
            // reading the data and formatting in order to be easier to work with it in google charts
            dataset_info = new google.visualization.DataTable();
            dataset_info.addColumn('string', 'contributor');
            dataset_info.addColumn('string', 'date_created');
            dataset_info.addColumn('string', 'description');
            dataset_info.addColumn('string', 'url');
            dataset_info.addColumn('string', 'version');
            dataset_info.addColumn('number', 'year');

            dataset_info.addRow([data_json.info.contributor, 
                        data_json.info.date_created,
                        data_json.info.description,
                        data_json.info.url,
                        data_json.info.version,
                        data_json.info.year]);

            // TODO
            // dataset_licenses = ;

            dataset_categories = new google.visualization.DataTable();
            dataset_categories.addColumn('number', 'id');
            dataset_categories.addColumn('string', 'name');
            dataset_categories.addColumn('string', 'supercategory');

            for (var i = 0; i < data_json.categories.length; i++) {
                dataset_categories.addRow([data_json.categories[i].id,
                                            data_json.categories[i].name,
                                            data_json.categories[i].supercategory]);
            }

            dataset_images = new google.visualization.DataTable();
            dataset_images.addColumn('string', 'id');
            dataset_images.addColumn('number', 'width');
            dataset_images.addColumn('number', 'height');
            dataset_images.addColumn('string', 'file_name');
            dataset_images.addColumn('number', 'license');
            dataset_images.addColumn('string', 'flickr_url');
            dataset_images.addColumn('string', 'coco_url');
            dataset_images.addColumn('string', 'date_captured');

            dataset_ImgsIds = []


            for (var i = 0; i < data_json.images.length; i++) {
                dataset_images.addRow([data_json.images[i].id,
                                        data_json.images[i].width,
                                        data_json.images[i].height,
                                        data_json.images[i].file_name,
                                        data_json.images[i].license,
                                        data_json.images[i].flickr_url,
                                        data_json.images[i].coco_url,
                                        data_json.images[i].date_captured]);
                dataset_ImgsIds.push(data_json.images[i].id)
            }

            dataset_annotations = new google.visualization.DataTable();
            dataset_annotations.addColumn('number', 'area');
            dataset_annotations.addColumn('number', 'bbox1');
            dataset_annotations.addColumn('number', 'bbox2');
            dataset_annotations.addColumn('number', 'bbox3');
            dataset_annotations.addColumn('number', 'bbox4');
            dataset_annotations.addColumn('number', 'category_id');
            dataset_annotations.addColumn('number', 'id');
            dataset_annotations.addColumn('string', 'image_id');
            dataset_annotations.addColumn('number', 'is_crowd');
            // dataset_categories.addColumn('????', 'segmentation');
            dataset_catToImgs = {}

            for (var i = 0; i < data_json.annotations.length; i++) {
                dataset_annotations.addRow([data_json.annotations[i].area,
                                            data_json.annotations[i].bbox[0],
                                            data_json.annotations[i].bbox[1],
                                            data_json.annotations[i].bbox[2],
                                            data_json.annotations[i].bbox[3],
                                            data_json.annotations[i].category_id,
                                            data_json.annotations[i].id,
                                            data_json.annotations[i].image_id,
                                            data_json.annotations[i].iscrowd]);
                if (dataset_catToImgs[data_json.annotations[i].category_id] != undefined){
                    dataset_catToImgs[data_json.annotations[i].category_id].push(data_json.annotations[i].image_id)
                } else {
                    dataset_catToImgs[data_json.annotations[i].category_id] = []
                    dataset_catToImgs[data_json.annotations[i].category_id].push(data_json.annotations[i].image_id)
                }
            }
            
            //TODO: tirar <<DEBUG>>
            // var table = new google.visualization.Table(document.getElementById('debugDiv1'));
            // table.draw(dataset_info, {showRowNumber: true, width: '100%', height: '100%'});
            // table = new google.visualization.Table(document.getElementById('debugDiv2'));
            // table.draw(dataset_categories, {showRowNumber: true, width: '100%', height: '100%'});
            // table = new google.visualization.Table(document.getElementById('debugDiv3'));
            // table.draw(dataset_annotations, {showRowNumber: true, width: '100%', height: '100%'});

            // TODO: talvez mostrar na tela as informações da base (dataset_info)
            
            //Draw each dashboard
            drawClassImbalanceDash(dataset_categories, dataset_annotations, dataset_catToImgs, dataset_ImgsIds);
            drawScaleImbalanceDas(dataset_categories, dataset_annotations);
            drawLocationImbalanceDash(dataset_categories, dataset_annotations);
        }

        function drawClassImbalanceDash(dataset_categories, dataset_annotations, dataset_catToImgs, dataset_ImgsIds){
            // group by class name
            var grouped_table = google.visualization.data.group(dataset_annotations, [5], 
                        [{'column': 5, 'aggregation': google.visualization.data.count, 'type': 'number'}]);
            
            // merging information to get class names
            var merged_table = google.visualization.data.join(dataset_categories, grouped_table,
                                'right', [[0,0]], [1], [1]);
            
            // removing the id column (only used to match both tables)
            merged_table.removeColumn(0);
            merged_table.setColumnLabel(0, "Class");
            merged_table.setColumnLabel(1, "Count");
            merged_table.sort({column: 1, desc: true});

            var options_horiz_bar = {
                chart: {
                    title: 'Total intances per class'//,
                    // subtitle: 'AMENO DORIME',
                },
                bars: 'horizontal', // Required for Material Bar Charts.
                // 'view': {'columns': [0, 3]}, //TODO: usar isso pra filtrar os dados do JSON!
                selectionMode: 'multiple',
                width: 900,
                height: 500
            };

            var horiz_chart = new google.charts.Bar(document.getElementById('horizBarDiv'));

            // The select handler. Call the chart's getSelection() method
            function selectHandler() {
                var selectedItem = horiz_chart.getSelection();
                if (selectedItem) {
                    if (selectedItem.length > 0) {
                        current_selected_classes = [];
                        selectedItem.forEach(element => {
                            current_selected_classes.push(element.row);
                        });
                        var old_selected_classes = [];
                        for (i of current_selected_classes) {
                            class_name = merged_table.getValue(i, 0);
                            for (var j = 0; j < dataset_categories.getNumberOfRows(); j++) {
                                if (class_name == dataset_categories.getValue(j, 1)) {
                                    old_selected_classes.push(j);
                                }
                            }
                        }
                        var view = new google.visualization.DataView(merged_table);
                        view.setRows(current_selected_classes);
                        pie_chart.draw(view, options_pie);
                        data_line = getLineChartValues(old_selected_classes, dataset_categories, dataset_catToImgs, dataset_ImgsIds);
                        line_chart.draw(data_line, options_line);
                    } else {
                        pie_chart.draw(merged_table, options_pie);
                        all_rows = [];
                        for (var i = 0; i < dataset_categories.getNumberOfRows(); i++) {
                            all_rows.push(i);
                        }
                        data_line = getLineChartValues(all_rows, dataset_categories, dataset_catToImgs, dataset_ImgsIds);
                        line_chart.draw(data_line, options_line);
                    }
                }
            }

            // Listen for the 'select' event, and call my function selectHandler() when
            // the user selects something on the chart.
            google.visualization.events.addListener(horiz_chart, 'select', selectHandler);

            horiz_chart.draw(merged_table, google.charts.Bar.convertOptions(options_horiz_bar));
            
            var options_pie = {
                title: 'Proportion of selected classes',
                width: 900,
                height: 500,
            };

            var pie_chart = new google.visualization.PieChart(document.getElementById('pieDiv'));

            pie_chart.draw(merged_table, options_pie);


            //Draw the scatter plot chart
            all_rows = [];
            for (var i = 0; i < dataset_categories.getNumberOfRows(); i++) {
                all_rows.push(i);
            }
            var data_line = getLineChartValues(all_rows, dataset_categories, dataset_catToImgs, dataset_ImgsIds);
            var options_line = {
                    hAxis: {
                    title: 'Number of Objects',
                    logScale: false,
                    minValue: 0,
                    format: '0'
                    },
                    vAxis: {
                    title: 'Number of Images',
                    logScale: false,
                    minValue: 0
                    },
            };
            var line_chart = new google.visualization.ScatterChart(document.getElementById('lineDiv'));
            line_chart.draw(data_line, options_line);
        }

        function drawScaleImbalanceDas(dataset_categories, dataset_annotations) {

        }

        function drawLocationImbalanceDash(dataset_categories, dataset_annotations) {

        }

        function getLineChartValues(selected_rows, dataset_categories, dataset_catToImgs, dataset_ImgsIds) {
            const countOccurrences = (arr, val) => arr.reduce((a, v) => (v === val ? a + 1 : a), 0);
            var imageOccurrences = {};
            for (var key of selected_rows) {
                var cat = dataset_categories.getValue(Number(key), 1);
                imageOccurrences[cat] = {};
                for (var img_id of dataset_ImgsIds) {
                    var cont = countOccurrences(dataset_catToImgs[key], img_id);
                    if (imageOccurrences[cat][cont] > 0) {
                        imageOccurrences[cat][cont] += 1;
                    } else {
                        imageOccurrences[cat][cont] = 1;
                    }
                }
            }
            data_line_raw = [['x']];
            for (i of selected_rows) {
                data_line_raw[0].push(dataset_categories.getValue(i, 1));
            }
            var max_value = 0;
            for (i of Object.keys(imageOccurrences)) {
                const max_class = Math.max.apply(Math, Object.keys(imageOccurrences[i]));
                if (max_value < max_class) {
                    max_value = max_class;
                }
            }
            for (var i = 0; i <= max_value; i++) {
                data_line_raw.push([i]);
                for (j of selected_rows) {
                    var cat = dataset_categories.getValue(j, 1);
                    if (imageOccurrences[cat][i] > 0) {
                        data_line_raw[i+1].push(imageOccurrences[cat][i]);
                    } else {
                        data_line_raw[i+1].push(0);
                    }
                }
            }
            return google.visualization.arrayToDataTable(data_line_raw);
        }
    </script>
</body>
</html>